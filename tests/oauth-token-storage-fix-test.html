<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Token Storage Fix Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        
        .test-section h3 {
            color: #007bff;
            margin-top: 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pass { background-color: #28a745; }
        .status-fail { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê OAuth Token Storage Fix Test</h1>
        <p><strong>Purpose:</strong> Test the fixed OAuth token storage mechanism for tab-based authentication</p>
        
        <div class="test-section">
            <h3>üéØ Test 1: Tab-Based OAuth Flow</h3>
            <p>Test the complete OAuth flow using the new tab-based authentication with beacon detection.</p>
            <button class="btn" onclick="testTabBasedOAuth()">Start Tab-Based OAuth Test</button>
            <div id="tab-oauth-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç Test 2: Beacon Detection System</h3>
            <p>Test the success beacon system that enables token detection across tabs.</p>
            <button class="btn" onclick="testBeaconSystem()">Test Beacon Detection</button>
            <div id="beacon-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-grid">
            <div class="test-section">
                <h3>üì° Test 3: BroadcastChannel Communication</h3>
                <p>Test cross-tab communication via BroadcastChannel.</p>
                <button class="btn" onclick="testBroadcastChannel()">Test BroadcastChannel</button>
                <div id="broadcast-result" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h3>üíæ Test 4: Token Storage Verification</h3>
                <p>Verify token storage and retrieval works correctly.</p>
                <button class="btn" onclick="testTokenStorage()">Test Token Storage</button>
                <div id="storage-result" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîÑ Test 5: Auth State Management</h3>
            <p>Test authentication state detection and event handling.</p>
            <button class="btn" onclick="testAuthStateManagement()">Test Auth State</button>
            <div id="auth-state-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üßπ Cleanup & Status</h3>
            <button class="btn" onclick="clearAllTokens()">Clear All Tokens</button>
            <button class="btn" onclick="checkCurrentTokenStatus()">Check Token Status</button>
            <button class="btn" onclick="simulateCallbackSuccess()">Simulate Callback Success</button>
            <div id="status-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info', elementId = 'status-result') {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = type === 'success' ? 'success' : 
                                 type === 'error' ? 'error' : 
                                 type === 'warning' ? 'warning' : 'info';
                element.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
                element.scrollTop = element.scrollHeight;
            }
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearResult(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '';
                element.style.display = 'none';
            }
        }

        // Test 1: Tab-Based OAuth Flow
        async function testTabBasedOAuth() {
            clearResult('tab-oauth-result');
            log('üöÄ Starting tab-based OAuth flow test...', 'info', 'tab-oauth-result');
            
            try {
                // Test if we can generate auth URL
                log('üìû Requesting OAuth authorization URL...', 'info', 'tab-oauth-result');
                
                const response = await fetch('/.netlify/functions/simple-ebay-oauth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'generate-auth-url' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Auth URL generated successfully', 'success', 'tab-oauth-result');
                    log(`üîó Auth URL: ${data.authUrl.substring(0, 80)}...`, 'info', 'tab-oauth-result');
                    
                    // Store return URL for callback
                    localStorage.setItem('ebay_oauth_return_url', window.location.href);
                    log('üíæ Return URL stored for callback', 'info', 'tab-oauth-result');
                    
                    log('üîó Opening OAuth in new tab...', 'info', 'tab-oauth-result');
                    log('‚ö†Ô∏è Complete authentication in the new tab and return here', 'warning', 'tab-oauth-result');
                    
                    // Open in new tab
                    window.open(data.authUrl, '_blank');
                    
                    // Set up listener for when user returns
                    setupReturnListener('tab-oauth-result');
                    
                } else {
                    log('‚ùå Failed to generate auth URL', 'error', 'tab-oauth-result');
                    log(`Error: ${response.status} ${response.statusText}`, 'error', 'tab-oauth-result');
                }
            } catch (error) {
                log(`‚ùå Error in OAuth flow test: ${error.message}`, 'error', 'tab-oauth-result');
            }
        }

        function setupReturnListener(resultId) {
            log('üëÇ Setting up return listener...', 'info', resultId);
            
            // Listen for focus events (when user returns to tab)
            const focusHandler = () => {
                log('üëÅÔ∏è Tab focused - checking for tokens...', 'info', resultId);
                checkForAuthSuccess(resultId);
            };
            
            // Listen for storage events
            const storageHandler = (e) => {
                if (e.key && e.key.includes('ebay') && e.key.includes('token')) {
                    log(`üì° Storage event detected: ${e.key}`, 'info', resultId);
                    checkForAuthSuccess(resultId);
                }
            };
            
            // Listen for BroadcastChannel messages
            let channel = null;
            if (typeof BroadcastChannel !== 'undefined') {
                channel = new BroadcastChannel('ebay-oauth-success');
                channel.addEventListener('message', (event) => {
                    log(`üì° BroadcastChannel message: ${event.data.type}`, 'success', resultId);
                    checkForAuthSuccess(resultId);
                });
            }
            
            // Set up URL parameter checking
            const urlHandler = () => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('ebay_connected') === 'true') {
                    log('üéâ OAuth success detected in URL!', 'success', resultId);
                    checkForAuthSuccess(resultId);
                }
            };
            
            window.addEventListener('focus', focusHandler);
            window.addEventListener('storage', storageHandler);
            window.addEventListener('popstate', urlHandler);
            
            // Initial URL check
            urlHandler();
            
            // Cleanup after 5 minutes
            setTimeout(() => {
                window.removeEventListener('focus', focusHandler);
                window.removeEventListener('storage', storageHandler);
                window.removeEventListener('popstate', urlHandler);
                if (channel) channel.close();
                log('‚è∞ Listener cleanup completed', 'info', resultId);
            }, 300000);
        }

        function checkForAuthSuccess(resultId) {
            log('üîç Checking for authentication success...', 'info', resultId);
            
            // Check for tokens in localStorage
            const oauthTokens = localStorage.getItem('ebay_oauth_tokens');
            const manualToken = localStorage.getItem('ebay_manual_token');
            const successBeacon = localStorage.getItem('ebay_oauth_success_beacon');
            
            if (oauthTokens || manualToken || successBeacon) {
                log('‚úÖ TOKENS FOUND! Authentication successful!', 'success', resultId);
                
                if (oauthTokens) {
                    try {
                        const tokens = JSON.parse(oauthTokens);
                        log(`üìã OAuth tokens: access_token length: ${tokens.access_token?.length || 0}`, 'success', resultId);
                        log(`üìã OAuth tokens: has refresh_token: ${!!tokens.refresh_token}`, 'success', resultId);
                    } catch (e) {
                        log('‚ö†Ô∏è Failed to parse OAuth tokens', 'warning', resultId);
                    }
                }
                
                if (manualToken) {
                    log(`üìã Manual token length: ${manualToken.length}`, 'success', resultId);
                }
                
                if (successBeacon) {
                    log('üéØ Success beacon found!', 'success', resultId);
                    try {
                        const beacon = JSON.parse(successBeacon);
                        log(`üìã Beacon timestamp: ${new Date(beacon.timestamp).toISOString()}`, 'success', resultId);
                    } catch (e) {
                        log('‚ö†Ô∏è Failed to parse success beacon', 'warning', resultId);
                    }
                }
                
                return true;
            } else {
                log('‚ùå No tokens found yet', 'error', resultId);
                return false;
            }
        }

        // Test 2: Beacon Detection System
        function testBeaconSystem() {
            clearResult('beacon-result');
            log('üéØ Testing beacon detection system...', 'info', 'beacon-result');
            
            // Create a test beacon
            const testBeacon = {
                success: true,
                tokens: {
                    access_token: 'test_beacon_token_12345',
                    refresh_token: 'test_beacon_refresh_67890',
                    expires_in: 7200,
                    token_type: 'Bearer',
                    expires_at: Date.now() + (7200 * 1000)
                },
                timestamp: Date.now(),
                source: 'test_beacon'
            };
            
            log('üìù Creating test beacon...', 'info', 'beacon-result');
            localStorage.setItem('ebay_oauth_success_beacon', JSON.stringify(testBeacon));
            
            log('üîç Beacon created, checking detection...', 'info', 'beacon-result');
            
            // Simulate beacon detection
            setTimeout(() => {
                const storedBeacon = localStorage.getItem('ebay_oauth_success_beacon');
                if (storedBeacon) {
                    log('‚úÖ Beacon detection test passed!', 'success', 'beacon-result');
                    log('üìã Beacon data found in localStorage', 'success', 'beacon-result');
                    
                    // Clean up test beacon
                    localStorage.removeItem('ebay_oauth_success_beacon');
                    log('üßπ Test beacon cleaned up', 'info', 'beacon-result');
                } else {
                    log('‚ùå Beacon detection test failed', 'error', 'beacon-result');
                }
            }, 100);
        }

        // Test 3: BroadcastChannel Communication
        function testBroadcastChannel() {
            clearResult('broadcast-result');
            log('üì° Testing BroadcastChannel communication...', 'info', 'broadcast-result');
            
            if (typeof BroadcastChannel === 'undefined') {
                log('‚ùå BroadcastChannel not supported in this browser', 'error', 'broadcast-result');
                return;
            }
            
            try {
                const channel = new BroadcastChannel('ebay-oauth-success');
                log('‚úÖ BroadcastChannel created successfully', 'success', 'broadcast-result');
                
                // Set up listener
                channel.addEventListener('message', (event) => {
                    log(`üì® Message received: ${event.data.type}`, 'success', 'broadcast-result');
                    log(`üìã Message data: ${JSON.stringify(event.data)}`, 'info', 'broadcast-result');
                });
                
                // Send test message
                const testMessage = {
                    type: 'EBAY_OAUTH_SUCCESS',
                    tokens: { access_token: 'test_broadcast_token' },
                    timestamp: Date.now()
                };
                
                log('üì§ Sending test message...', 'info', 'broadcast-result');
                channel.postMessage(testMessage);
                
                // Clean up
                setTimeout(() => {
                    channel.close();
                    log('üßπ BroadcastChannel closed', 'info', 'broadcast-result');
                }, 1000);
                
            } catch (error) {
                log(`‚ùå BroadcastChannel error: ${error.message}`, 'error', 'broadcast-result');
            }
        }

        // Test 4: Token Storage Verification
        function testTokenStorage() {
            clearResult('storage-result');
            log('üíæ Testing token storage and retrieval...', 'info', 'storage-result');
            
            const testTokens = {
                access_token: 'test_storage_token_12345',
                refresh_token: 'test_storage_refresh_67890',
                expires_in: 7200,
                token_type: 'Bearer',
                expires_at: Date.now() + (7200 * 1000),
                scope: 'https://api.ebay.com/oauth/api_scope/sell.inventory'
            };
            
            try {
                // Test storage
                log('üìù Storing test tokens...', 'info', 'storage-result');
                localStorage.setItem('ebay_oauth_tokens', JSON.stringify(testTokens));
                localStorage.setItem('ebay_manual_token', testTokens.access_token);
                
                // Test retrieval
                log('üîç Retrieving stored tokens...', 'info', 'storage-result');
                const storedOAuth = localStorage.getItem('ebay_oauth_tokens');
                const storedManual = localStorage.getItem('ebay_manual_token');
                
                if (storedOAuth && storedManual) {
                    const parsed = JSON.parse(storedOAuth);
                    if (parsed.access_token === testTokens.access_token) {
                        log('‚úÖ Token storage test passed!', 'success', 'storage-result');
                        log(`üìã OAuth token retrieved: ${parsed.access_token.substring(0, 20)}...`, 'success', 'storage-result');
                        log(`üìã Manual token retrieved: ${storedManual.substring(0, 20)}...`, 'success', 'storage-result');
                    } else {
                        log('‚ùå Token mismatch after storage', 'error', 'storage-result');
                    }
                } else {
                    log('‚ùå Failed to retrieve stored tokens', 'error', 'storage-result');
                }
                
                // Clean up
                localStorage.removeItem('ebay_oauth_tokens');
                localStorage.removeItem('ebay_manual_token');
                log('üßπ Test tokens cleaned up', 'info', 'storage-result');
                
            } catch (error) {
                log(`‚ùå Storage test error: ${error.message}`, 'error', 'storage-result');
            }
        }

        // Test 5: Auth State Management
        function testAuthStateManagement() {
            clearResult('auth-state-result');
            log('üîÑ Testing authentication state management...', 'info', 'auth-state-result');
            
            // Test custom events
            log('üì° Testing custom events...', 'info', 'auth-state-result');
            
            let eventReceived = false;
            const eventHandler = (e) => {
                log(`üì® Custom event received: ${e.type}`, 'success', 'auth-state-result');
                log(`üìã Event detail: ${JSON.stringify(e.detail)}`, 'info', 'auth-state-result');
                eventReceived = true;
            };
            
            window.addEventListener('ebayAuthChanged', eventHandler);
            
            // Dispatch test event
            window.dispatchEvent(new CustomEvent('ebayAuthChanged', {
                detail: { authenticated: true, source: 'test', timestamp: Date.now() }
            }));
            
            setTimeout(() => {
                if (eventReceived) {
                    log('‚úÖ Custom event system working!', 'success', 'auth-state-result');
                } else {
                    log('‚ùå Custom event system failed', 'error', 'auth-state-result');
                }
                
                window.removeEventListener('ebayAuthChanged', eventHandler);
                log('üßπ Event listener cleaned up', 'info', 'auth-state-result');
            }, 500);
            
            // Test storage events
            log('üì¶ Testing storage events...', 'info', 'auth-state-result');
            
            let storageEventReceived = false;
            const storageHandler = (e) => {
                if (e.key === 'test_ebay_token') {
                    log(`üì® Storage event received: ${e.key}`, 'success', 'auth-state-result');
                    storageEventReceived = true;
                }
            };
            
            window.addEventListener('storage', storageHandler);
            
            // Trigger storage event
            localStorage.setItem('test_ebay_token', 'test_value');
            localStorage.removeItem('test_ebay_token');
            
            setTimeout(() => {
                if (storageEventReceived) {
                    log('‚úÖ Storage event system working!', 'success', 'auth-state-result');
                } else {
                    log('‚ö†Ô∏è Storage event not received (normal for same-tab)', 'warning', 'auth-state-result');
                }
                
                window.removeEventListener('storage', storageHandler);
                log('üßπ Storage listener cleaned up', 'info', 'auth-state-result');
            }, 500);
        }

        // Utility functions
        function clearAllTokens() {
            clearResult('status-result');
            log('üßπ Clearing all OAuth tokens and beacons...', 'info', 'status-result');
            
            const keysToRemove = [
                'ebay_oauth_tokens', 'oauth_tokens', 'ebay_manual_token',
                'ebay_access_token', 'ebay_refresh_token', 'ebay_token_expiry',
                'easyflip_ebay_access_token', 'easyflip_ebay_refresh_token',
                'easyflip_ebay_token_expiry', 'easyflip_ebay_token_scope',
                'ebay_oauth_success_beacon', 'ebay_oauth_beacon',
                'ebay_oauth_state', 'ebay_oauth_return_url'
            ];
            
            let removedCount = 0;
            keysToRemove.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    removedCount++;
                    log(`üóëÔ∏è Removed: ${key}`, 'info', 'status-result');
                }
            });
            
            log(`‚úÖ Cleanup complete! Removed ${removedCount} items`, 'success', 'status-result');
        }

        function checkCurrentTokenStatus() {
            clearResult('status-result');
            log('üîç Checking current token status...', 'info', 'status-result');
            
            const keys = Object.keys(localStorage).filter(key => key.includes('ebay'));
            if (keys.length === 0) {
                log('‚ùå No eBay-related tokens found', 'error', 'status-result');
                return;
            }
            
            log(`üìã Found ${keys.length} eBay-related localStorage keys:`, 'info', 'status-result');
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    log(`  ‚Ä¢ ${key}: ${value.length} chars`, 'info', 'status-result');
                    if (key.includes('token') && value.length > 100) {
                        log(`    Preview: ${value.substring(0, 50)}...`, 'info', 'status-result');
                    }
                }
            });
            
            // Check for specific token types
            const oauthTokens = localStorage.getItem('ebay_oauth_tokens');
            if (oauthTokens) {
                try {
                    const tokens = JSON.parse(oauthTokens);
                    log('‚úÖ OAuth tokens found and valid!', 'success', 'status-result');
                    log(`  ‚Ä¢ Access token: ${tokens.access_token ? 'Present' : 'Missing'}`, 'info', 'status-result');
                    log(`  ‚Ä¢ Refresh token: ${tokens.refresh_token ? 'Present' : 'Missing'}`, 'info', 'status-result');
                    log(`  ‚Ä¢ Expires at: ${tokens.expires_at ? new Date(tokens.expires_at).toISOString() : 'Unknown'}`, 'info', 'status-result');
                } catch (e) {
                    log('‚ö†Ô∏è OAuth tokens found but invalid JSON', 'warning', 'status-result');
                }
            }
        }

        function simulateCallbackSuccess() {
            clearResult('status-result');
            log('üé≠ Simulating callback success...', 'info', 'status-result');
            
            const mockTokens = {
                access_token: 'simulated_access_token_' + Date.now(),
                refresh_token: 'simulated_refresh_token_' + Date.now(),
                expires_in: 7200,
                token_type: 'Bearer',
                expires_at: Date.now() + (7200 * 1000),
                scope: 'https://api.ebay.com/oauth/api_scope/sell.inventory https://api.ebay.com/oauth/api_scope/sell.account'
            };
            
            // Store tokens like the callback would
            localStorage.setItem('ebay_oauth_tokens', JSON.stringify(mockTokens));
            localStorage.setItem('ebay_manual_token', mockTokens.access_token);
            
            // Create success beacon
            const beacon = {
                success: true,
                tokens: mockTokens,
                timestamp: Date.now(),
                source: 'simulated_callback'
            };
            localStorage.setItem('ebay_oauth_success_beacon', JSON.stringify(beacon));
            
            log('‚úÖ Simulated tokens stored successfully!', 'success', 'status-result');
            log('üì° Dispatching auth changed event...', 'info', 'status-result');
            
            // Dispatch events
            window.dispatchEvent(new CustomEvent('ebayAuthChanged', {
                detail: { authenticated: true, source: 'simulation', tokens: mockTokens }
            }));
            
            // Send BroadcastChannel message
            if (typeof BroadcastChannel !== 'undefined') {
                try {
                    const channel = new BroadcastChannel('ebay-oauth-success');
                    channel.postMessage({
                        type: 'EBAY_OAUTH_SUCCESS',
                        tokens: mockTokens,
                        timestamp: Date.now()
                    });
                    channel.close();
                    log('üì° BroadcastChannel message sent', 'success', 'status-result');
                } catch (e) {
                    log('‚ö†Ô∏è BroadcastChannel failed', 'warning', 'status-result');
                }
            }
            
            log('üéâ Simulation complete! Check token status to verify.', 'success', 'status-result');
        }

        // Initialize page
        window.addEventListener('load', () => {
            console.log('üîê OAuth Token Storage Fix Test loaded');
            
            // Check if we're returning from OAuth
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('ebay_connected') === 'true') {
                log('üéâ Detected return from OAuth! Checking tokens...', 'success', 'status-result');
                document.getElementById('status-result').style.display = 'block';
                setTimeout(() => checkCurrentTokenStatus(), 500);
            }
        });
    </script>
</body>
</html>